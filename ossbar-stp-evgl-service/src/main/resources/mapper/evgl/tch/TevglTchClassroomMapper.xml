<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ossbar.modules.evgl.tch.persistence.TevglTchClassroomMapper">
	<resultMap id="BaseResultMap"
		type="com.ossbar.modules.evgl.tch.domain.TevglTchClassroom">
		<result column="ct_id" jdbcType="VARCHAR"
			property="ctId" />
		<result column="major_id" jdbcType="VARCHAR"
			property="majorId" />
		<result column="teacher_id" jdbcType="VARCHAR"
			property="teacherId" />
		<result column="class_id" jdbcType="VARCHAR"
			property="classId" />
		<result column="pkg_id" jdbcType="VARCHAR"
			property="pkgId" />
		<result column="is_public" jdbcType="VARCHAR"
			property="isPublic" />
		<result column="pic" jdbcType="VARCHAR"
			property="pic" />
		<result column="invitation_code" jdbcType="VARCHAR"
			property="invitationCode" />
		<result column="name" jdbcType="VARCHAR"
			property="name" />
		<result column="intro" jdbcType="VARCHAR"
			property="intro" />
		<result column="study_num" jdbcType="INTEGER"
			property="studyNum" />
		<result column="create_user_id" jdbcType="VARCHAR"
			property="createUserId" />
		<result column="create_time" jdbcType="VARCHAR"
			property="createTime" />
		<result column="update_time" jdbcType="VARCHAR"
			property="updateTime" />
		<result column="update_user_id" jdbcType="VARCHAR"
			property="updateUserId" />
		<result column="state" jdbcType="VARCHAR"
			property="state" />
		<result column="trainee_id" jdbcType="VARCHAR"
			property="traineeId" />
		<result column="classroom_state" jdbcType="VARCHAR"
			property="classroomState" />
		<result column="is_check" jdbcType="VARCHAR"
			property="isCheck" />
		<result column="is_top" jdbcType="VARCHAR"
			property="isTop" />
		<result column="qr_code" jdbcType="VARCHAR"
			property="qrCode" />
		<result column="collect_num" jdbcType="INTEGER"
			property="collectNum" />
		<result column="like_num" jdbcType="INTEGER"
			property="likeNum" />
		<result column="begin_time" jdbcType="VARCHAR"
			property="beginTime" />
		<result column="end_time" jdbcType="VARCHAR"
			property="endTime" />
		<result column="platform_audit_status" jdbcType="VARCHAR"
			property="platformAuditStatus" />
		<result column="view_num" jdbcType="INTEGER"
			property="viewNum" />
		<result column="if_live_lesson" jdbcType="VARCHAR"
			property="ifLiveLesson" />
		<result column="link_url" jdbcType="VARCHAR"
			property="linkUrl" />	
		<result column="receiver_user_id" jdbcType="VARCHAR"
				property="receiverUserId" />		
	</resultMap>

	<!-- 用于select查询公用抽取的列 -->
	<sql id="Base_Column_List">
		ct_id,major_id,teacher_id,class_id,pkg_id,is_public,pic,invitation_code,name,intro,study_num,create_user_id,create_time,update_time,update_user_id,state,trainee_id
		,classroom_state,is_check,is_top,qr_code,collect_num,like_num,begin_time,end_time,platform_audit_status
		,view_num,if_live_lesson,link_url,receiver_user_id
	</sql>
	
	<sql id="Base_NOINTEGER_Column_List">
		ct_id,major_id,teacher_id,class_id,pkg_id,is_public,pic,invitation_code,name,intro,create_user_id,update_time,update_user_id,state,trainee_id
		,classroom_state,is_check,is_top,qr_code,begin_time,end_time,platform_audit_status
	</sql>
	<insert id="insert" parameterType="com.ossbar.modules.evgl.tch.domain.TevglTchClassroom">
		INSERT INTO T_EVGL_TCH_CLASSROOM (
		ct_id ,
		major_id ,
		teacher_id ,
		class_id ,
		pkg_id ,
		is_public ,
		pic ,
		invitation_code ,
		name ,
		intro ,
		study_num ,
		create_user_id ,
		create_time ,
		update_time ,
		update_user_id ,
		state ,
		trainee_id ,
		classroom_state ,
		is_check ,
		is_top ,
		qr_code ,
		collect_num ,
		like_num ,
		begin_time ,
		end_time ,
		platform_audit_status,
		view_num ,
		if_live_lesson ,
		link_url 
		) VALUES (

#{ctId,jdbcType=VARCHAR} ,

#{majorId,jdbcType=VARCHAR} ,

#{teacherId,jdbcType=VARCHAR} ,

#{classId,jdbcType=VARCHAR} ,

#{pkgId,jdbcType=VARCHAR} ,

#{isPublic,jdbcType=VARCHAR} ,

#{pic,jdbcType=VARCHAR} ,

#{invitationCode,jdbcType=VARCHAR} ,

#{name,jdbcType=VARCHAR} ,

#{intro,jdbcType=VARCHAR} ,

#{studyNum,jdbcType=INTEGER} ,

#{createUserId,jdbcType=VARCHAR} ,

#{createTime,jdbcType=VARCHAR} ,

#{updateTime,jdbcType=VARCHAR} ,

#{updateUserId,jdbcType=VARCHAR} ,

#{state,jdbcType=VARCHAR} ,

#{traineeId,jdbcType=VARCHAR} ,

#{classroomState,jdbcType=VARCHAR} ,

#{isCheck,jdbcType=VARCHAR} ,

#{isTop,jdbcType=VARCHAR} ,

#{qrCode,jdbcType=VARCHAR} ,

#{collectNum,jdbcType=INTEGER} ,

#{likeNum,jdbcType=INTEGER} ,

#{beginTime,jdbcType=VARCHAR} ,

#{endTime,jdbcType=VARCHAR} ,

#{platformAuditStatus,jdbcType=VARCHAR}  ,

#{viewNum,jdbcType=INTEGER} ,

#{ifLiveLesson,jdbcType=VARCHAR} ,

#{linkUrl,jdbcType=VARCHAR} 
		)
	</insert>
	<update id="update" parameterType="com.ossbar.modules.evgl.tch.domain.TevglTchClassroom">
		UPDATE T_EVGL_TCH_CLASSROOM 
		<set>
		<if test="traineeId != null">
		trainee_id = #{traineeId,jdbcType=VARCHAR},
		</if>
		<if test="traineeId == null">
		trainee_id = "",
		</if>
		<if test="majorId != null">
		major_id = #{majorId,jdbcType=VARCHAR},
		</if>
		<if test="teacherId != null">
		teacher_id = #{teacherId,jdbcType=VARCHAR},
		</if>
		<if test="classId != null">
		class_id = #{classId,jdbcType=VARCHAR},
		</if>
		<if test="pkgId != null">
		pkg_id = #{pkgId,jdbcType=VARCHAR},
		</if>
		<if test="isPublic != null">
		is_public = #{isPublic,jdbcType=VARCHAR},
		</if>
		<if test="pic != null">
		pic = #{pic,jdbcType=VARCHAR},
		</if>
		<if test="invitationCode != null">
		invitation_code = #{invitationCode,jdbcType=VARCHAR},
		</if>
		<if test="name != null">
		name = #{name,jdbcType=VARCHAR},
		</if>
		<if test="intro != null">
		intro = #{intro,jdbcType=VARCHAR},
		</if>
		<if test="studyNum != null">
		study_num = #{studyNum,jdbcType=INTEGER},
		</if>
		<if test="createUserId != null">
		create_user_id = #{createUserId,jdbcType=VARCHAR},
		</if>
		<if test="createTime != null">
		create_time = #{createTime,jdbcType=VARCHAR},
		</if>
		<if test="updateTime != null">
		update_time = #{updateTime,jdbcType=VARCHAR},
		</if>
		<if test="updateUserId != null">
		update_user_id = #{updateUserId,jdbcType=VARCHAR},
		</if>
		<if test="state != null">
		state = #{state,jdbcType=VARCHAR},
		</if>
		<if test="classroomState != null">
		classroom_state = #{classroomState,jdbcType=VARCHAR},
		</if>
		<if test="isCheck != null">
		is_check = #{isCheck,jdbcType=VARCHAR},
		</if>
		<if test="isTop != null">
		is_top = #{isTop,jdbcType=VARCHAR},
		</if>
		<if test="qrCode != null">
		qr_code = #{qrCode,jdbcType=VARCHAR},
		</if>
		<if test="collectNum != null">
		collect_num = #{collectNum,jdbcType=INTEGER},
		</if>
		<if test="likeNum != null">
		like_num = #{likeNum,jdbcType=INTEGER},
		</if>
		<if test="beginTime != null">
		begin_time = #{beginTime,jdbcType=VARCHAR},
		</if>
		<if test="endTime != null">
		end_time = #{endTime,jdbcType=VARCHAR},
		</if>
		<if test="platformAuditStatus != null">
		platform_audit_status = #{platformAuditStatus,jdbcType=VARCHAR},
		</if>
		<if test="viewNum != null">
		view_num = #{viewNum,jdbcType=INTEGER},
		</if>
		<if test="ifLiveLesson != null">
		if_live_lesson = #{ifLiveLesson,jdbcType=VARCHAR},
		</if>
		<if test="linkUrl != null">
		link_url = #{linkUrl,jdbcType=VARCHAR},
		</if>
		<if test="receiverUserId != null and receiverUserId.trim() != ''">
			receiver_user_id = #{receiverUserId,jdbcType=VARCHAR},
		</if>
		</set>
		WHERE
		ct_id = #{ctId,jdbcType=VARCHAR} 
	</update>
	<delete id="delete" parameterType="java.lang.String">
		DELETE FROM T_EVGL_TCH_CLASSROOM WHERE
		ct_id =
		#{ctId,jdbcType=VARCHAR} 
	</delete>
	<delete id="deleteBatch" parameterType="java.lang.String">
		DELETE FROM T_EVGL_TCH_CLASSROOM WHERE
		ct_id in
		<foreach item="ctId" collection="array" open="("
			separator="," close=")">
#{ctId,jdbcType=VARCHAR} 
		</foreach>
	</delete>
	<select id="selectObjectById" parameterType="java.lang.String"
		resultMap="BaseResultMap">
		select t1.*, t2.subject_id, t2.pkg_name
		from T_EVGL_TCH_CLASSROOM t1
		left join t_evgl_pkg_info t2 on t1.pkg_id = t2.pkg_id
		where t1.ct_id = #{ctId,jdbcType=VARCHAR} 
	</select>
	<select id="selectObjectByPkgId" parameterType="java.lang.String"
		resultMap="BaseResultMap">
		select t1.*, t2.subject_id, t2.pkg_name
		from T_EVGL_TCH_CLASSROOM t1
		left join t_evgl_pkg_info t2 on t1.pkg_id = t2.pkg_id
		where t1.pkg_id = #{pkgId,jdbcType=VARCHAR} 
	</select>
	<!-- 实际业务需要增加的SQL语句 -->
    <select id="selectListByMap" resultMap="BaseResultMap"
        parameterType="map">
        select t1.*, t2.pkg_name, t3.class_name 
        from T_EVGL_TCH_CLASSROOM t1
        inner join t_evgl_pkg_info t2 on t1.pkg_id = t2.pkg_id
        left join t_evgl_tch_class t3 on t1.class_id = t3.class_id
        <where>
        		<if test="pkgIds != null and pkgIds.size() > 0">
        		and t2.pkg_id in
	        		<foreach collection="pkgIds" item="pkgId" open="(" close=")" separator=",">
	        			#{pkgId,jdbcType=VARCHAR}
	        		</foreach>
        		</if>
        		<if test="subjectId != null and subjectId.trim() != ''">
                and t2.subject_id =#{subjectId,jdbcType=VARCHAR}            
                </if>
                <if test="majorId != null and majorId.trim() != ''">
                and t1.major_id =#{majorId,jdbcType=VARCHAR}            </if>
                <if test="teacherId != null and teacherId.trim() != ''">
                and t1.teacher_id =#{teacherId,jdbcType=VARCHAR}            </if>
                <if test="classId != null and classId.trim() != ''">
                and t1.class_id =#{classId,jdbcType=VARCHAR}            </if>
                <if test="pkgId != null and pkgId.trim() != ''">
                and t1.pkg_id =#{pkgId,jdbcType=VARCHAR}            </if>
                <if test="isPublic != null and isPublic.trim() != ''">
                and t1.is_public =#{isPublic,jdbcType=VARCHAR}            </if>
                <if test="pic != null and pic.trim() != ''">
                and t1.pic =#{pic,jdbcType=VARCHAR}            </if>
                <if test="invitationCode != null and invitationCode.trim() != ''">
                and t1.invitation_code =#{invitationCode,jdbcType=VARCHAR}            </if>
                <if test="name != null and name.trim() != ''">
                and t1.name =#{name,jdbcType=VARCHAR}            </if>
                <if test="intro != null and intro.trim() != ''">
                and t1.intro =#{intro,jdbcType=VARCHAR}            </if>
                <if test="studyNum != null and studyNum != ''">
                and t1.study_num =#{studyNum,jdbcType=INTEGER}            </if>
                <if test="createUserId != null and createUserId.trim() != ''">
                and t1.create_user_id =#{createUserId,jdbcType=VARCHAR}            </if>
                <if test="createTime != null and createTime.trim() != ''">
                and t1.create_time =#{createTime,jdbcType=VARCHAR}            </if>
                <if test="updateTime != null and updateTime.trim() != ''">
                and t1.update_time =#{updateTime,jdbcType=VARCHAR}            </if>
                <if test="updateUserId != null and updateUserId.trim() != ''">
                and t1.update_user_id =#{updateUserId,jdbcType=VARCHAR}            </if>
                <if test="state != null and state.trim() != ''">
                and t1.state =#{state,jdbcType=VARCHAR}            </if>
                <if test="traineeId != null and traineeId.trim() != ''">
                and t1.trainee_id =#{traineeId,jdbcType=VARCHAR}            </if>
                <if test="classroomState != null and classroomState.trim() != ''">
                and t1.classroom_state =#{classroomState,jdbcType=VARCHAR}            </if>
                <if test="isCheck != null and isCheck.trim() != ''">
                and t1.is_check =#{isCheck,jdbcType=VARCHAR}            </if>
                <if test="isTop != null and isTop.trim() != ''">
                and t1.is_top =#{isTop,jdbcType=VARCHAR}            </if>
                <if test="qrCode != null and qrCode.trim() != ''">
                and t1.qr_code =#{qrCode,jdbcType=VARCHAR}            </if>
                <if test="collectNum != null and collectNum != ''">
                and t1.collect_num =#{collectNum,jdbcType=INTEGER}            </if>
                <if test="likeNum != null and likeNum != ''">
                and t1.like_num =#{likeNum,jdbcType=INTEGER}            </if>
                <if test="beginTime != null and beginTime.trim() != ''">
                and t1.begin_time =#{beginTime,jdbcType=VARCHAR}            </if>
                <if test="endTime != null and endTime.trim() != ''">
                and t1.end_time =#{endTime,jdbcType=VARCHAR}            </if>
                <if test="platformAuditStatus != null and platformAuditStatus.trim() != ''">
                and t1.platform_audit_status =#{platformAuditStatus,jdbcType=VARCHAR}            </if>
                <if test="ifLiveLesson != null and ifLiveLesson.trim() != ''">
                and t1.if_live_lesson =#{ifLiveLesson,jdbcType=VARCHAR}            </if>
                <if test="linkUrl != null and linkUrl.trim() != ''">
                and t1.link_url =#{linkUrl,jdbcType=VARCHAR}            </if>
                
        </where>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by ct_id  desc
            </otherwise>
        </choose>
    </select>
    
    <select id="selectListMapByMap" resultType="map"
        parameterType="map">
        select major.major_name, tchclass.class_name, t2.teacher_name, pkg.pkg_name, pkg.pkg_version,
		t1.ct_id, t1.major_id, t1.teacher_id, t1.class_id, t1.pkg_id, t1.pic, t1.invitation_code, t1.name, t1.study_num, 
		t1.classroom_state, t1.create_time, t0.mobile,
		t1.receiver_user_id
		from T_EVGL_TCH_CLASSROOM t1
		left join t_evgl_tch_teacher t2 on t1.teacher_id = t2.teacher_id
		left join t_evgl_book_major major on t1.major_id = major.major_id
		left join t_evgl_tch_class tchclass on t1.class_id = tchclass.class_id
		left join t_evgl_pkg_info pkg on t1.pkg_id = pkg.pkg_id
		left join t_evgl_trainee_info t0 on t1.create_user_id = t0.trainee_id
        <where>
        		<if test="teacherName != null and teacherName.trim() != ''">
					and t2.teacher_name like concat ('%', #{teacherName,jdbcType=VARCHAR}, '%')            </if>
				<if test="mobile != null and mobile.trim() != ''">
					and t2.username like concat ('%', #{mobile,jdbcType=VARCHAR}, '%')            </if>
        		<if test="teacherIds != null and teacherIds.size() > 0">
                	and t1.teacher_id in
                	<foreach collection="teacherIds" item="teacherId" open="(" separator="," close=")">
                		#{teacherId} 
                	</foreach>
                </if>
        		<if test="withinyear != null and withinyear.trim() != ''">
                AND DATE_SUB(CURDATE(), INTERVAL 1 YEAR) <![CDATA[<= ]]> date(t1.create_time)         
                </if>
                <if test="majorId != null and majorId.trim() != ''">
                and t1.major_id =#{majorId,jdbcType=VARCHAR}            </if>
                <if test="teacherId != null and teacherId.trim() != ''">
                and t1.teacher_id =#{teacherId,jdbcType=VARCHAR}            </if>
                <if test="classId != null and classId.trim() != ''">
                and t1.class_id =#{classId,jdbcType=VARCHAR}            </if>
                <if test="pkgId != null and pkgId.trim() != ''">
                and t1.pkg_id =#{pkgId,jdbcType=VARCHAR}            </if>
                <if test="isPublic != null and isPublic.trim() != ''">
                and t1.is_public =#{isPublic,jdbcType=VARCHAR}            </if>
                <if test="pic != null and pic.trim() != ''">
                and t1.pic =#{pic,jdbcType=VARCHAR}            </if>
                <if test="invitationCode != null and invitationCode.trim() != ''">
                and t1.invitation_code =#{invitationCode,jdbcType=VARCHAR}            </if>
                <if test="name != null and name.trim() != ''">
                and t1.name like concat ('%', #{name,jdbcType=VARCHAR}, '%')            </if>
                <if test="intro != null and intro.trim() != ''">
                and t1.intro =#{intro,jdbcType=VARCHAR}            </if>
                <if test="studyNum != null and studyNum != ''">
                and t1.study_num =#{studyNum,jdbcType=INTEGER}            </if>
                <if test="createUserId != null and createUserId.trim() != ''">
                and t1.create_user_id =#{createUserId,jdbcType=VARCHAR}            </if>
                <if test="createTime != null and createTime.trim() != ''">
                and t1.create_time =#{createTime,jdbcType=VARCHAR}            </if>
                <if test="updateTime != null and updateTime.trim() != ''">
                and t1.update_time =#{updateTime,jdbcType=VARCHAR}            </if>
                <if test="updateUserId != null and updateUserId.trim() != ''">
                and t1.update_user_id =#{updateUserId,jdbcType=VARCHAR}            </if>
                <if test="state != null and state.trim() != ''">
                and t1.state =#{state,jdbcType=VARCHAR}            </if>
                <if test="traineeId != null and traineeId.trim() != ''">
                and t1.trainee_id =#{traineeId,jdbcType=VARCHAR}            </if>
                <if test="classroomState != null and classroomState.trim() != ''">
                and t1.classroom_state =#{classroomState,jdbcType=VARCHAR}            </if>
                <if test="isCheck != null and isCheck.trim() != ''">
                and t1.is_check =#{isCheck,jdbcType=VARCHAR}            </if>
                <if test="isTop != null and isTop.trim() != ''">
                and t1.is_top =#{isTop,jdbcType=VARCHAR}            </if>
                <if test="qrCode != null and qrCode.trim() != ''">
                and t1.qr_code =#{qrCode,jdbcType=VARCHAR}            </if>
                <if test="collectNum != null and collectNum != ''">
                and t1.collect_num =#{collectNum,jdbcType=INTEGER}            </if>
                <if test="likeNum != null and likeNum != ''">
                and t1.like_num =#{likeNum,jdbcType=INTEGER}            </if>
                <if test="beginTime != null and beginTime.trim() != ''">
                and t1.begin_time =#{beginTime,jdbcType=VARCHAR}            </if>
                <if test="endTime != null and endTime.trim() != ''">
                and t1.end_time =#{endTime,jdbcType=VARCHAR}            </if>
                <if test="platformAuditStatus != null and platformAuditStatus.trim() != ''">
                and t1.platform_audit_status =#{platformAuditStatus,jdbcType=VARCHAR}            </if>
                <if test="ifLiveLesson != null and ifLiveLesson.trim() != ''">
                and t1.if_live_lesson =#{ifLiveLesson,jdbcType=VARCHAR}            </if>
                <if test="linkUrl != null and linkUrl.trim() != ''">
                and t1.link_url =#{linkUrl,jdbcType=VARCHAR}            </if>
        </where>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by t1.ct_id  desc
            </otherwise>
        </choose>
    </select>
    
    <!-- 查询课堂的创建时间且只查询有效的课堂创建时间，按降序排列 -->
    <select id="selectCreateClassroomYear" resultType="map"
        parameterType="map">
    	SELECT DISTINCT
			substr( create_time, 1, 4 ) createYears
		FROM
			t_evgl_tch_classroom 
		<where>
			<if test="createUserId != null and createUserId.trim() != ''">
                and create_user_id =#{createUserId,jdbcType=VARCHAR}            
            </if>
            and state = "Y"
		</where>
		ORDER BY create_time desc
    </select>
    
    <select id="selectClassroomYear" resultType="map"
        parameterType="map">
        select DISTINCT create_time,
		<include refid="Base_NOINTEGER_Column_List"/>
		from T_EVGL_TCH_CLASSROOM t1
        <where>
        		<if test="teacherIds != null and teacherIds.size() > 0">
                	and t1.teacher_id in
                	<foreach collection="teacherIds" item="teacherId" open="(" separator="," close=")">
                		#{teacherId} 
                	</foreach>
                </if>
        		
                <if test="majorId != null and majorId.trim() != ''">
                and t1.major_id =#{majorId,jdbcType=VARCHAR}            </if>
                <if test="teacherId != null and teacherId.trim() != ''">
                and t1.teacher_id =#{teacherId,jdbcType=VARCHAR}            </if>
                <if test="classId != null and classId.trim() != ''">
                and t1.class_id =#{classId,jdbcType=VARCHAR}            </if>
                <if test="pkgId != null and pkgId.trim() != ''">
                and t1.pkg_id =#{pkgId,jdbcType=VARCHAR}            </if>
                <if test="isPublic != null and isPublic.trim() != ''">
                and t1.is_public =#{isPublic,jdbcType=VARCHAR}            </if>
                <if test="pic != null and pic.trim() != ''">
                and t1.pic =#{pic,jdbcType=VARCHAR}            </if>
                <if test="invitationCode != null and invitationCode.trim() != ''">
                and t1.invitation_code =#{invitationCode,jdbcType=VARCHAR}            </if>
                <if test="name != null and name.trim() != ''">
                and t1.name =#{name,jdbcType=VARCHAR}            </if>
                <if test="intro != null and intro.trim() != ''">
                and t1.intro =#{intro,jdbcType=VARCHAR}            </if>
                <if test="createUserId != null and createUserId.trim() != ''">
                and t1.create_user_id =#{createUserId,jdbcType=VARCHAR}            </if>
                <if test="createTime != null and createTime.trim() != ''">
                and t1.create_time =#{createTime,jdbcType=VARCHAR}            </if>
                <if test="updateTime != null and updateTime.trim() != ''">
                and t1.update_time =#{updateTime,jdbcType=VARCHAR}            </if>
                <if test="updateUserId != null and updateUserId.trim() != ''">
                and t1.update_user_id =#{updateUserId,jdbcType=VARCHAR}            </if>
                <if test="state != null and state.trim() != ''">
                and t1.state =#{state,jdbcType=VARCHAR}            </if>
                <if test="traineeId != null and traineeId.trim() != ''">
                and t1.trainee_id =#{traineeId,jdbcType=VARCHAR}            </if>
                <if test="classroomState != null and classroomState.trim() != ''">
                and t1.classroom_state =#{classroomState,jdbcType=VARCHAR}            </if>
                <if test="isCheck != null and isCheck.trim() != ''">
                and t1.is_check =#{isCheck,jdbcType=VARCHAR}            </if>
                <if test="isTop != null and isTop.trim() != ''">
                and t1.is_top =#{isTop,jdbcType=VARCHAR}            </if>
                <if test="qrCode != null and qrCode.trim() != ''">
                and t1.qr_code =#{qrCode,jdbcType=VARCHAR}            </if>
                <if test="beginTime != null and beginTime.trim() != ''">
                and t1.begin_time =#{beginTime,jdbcType=VARCHAR}            </if>
                <if test="endTime != null and endTime.trim() != ''">
                and t1.end_time =#{endTime,jdbcType=VARCHAR}            </if>
                <if test="platformAuditStatus != null and platformAuditStatus.trim() != ''">
                and t1.platform_audit_status =#{platformAuditStatus,jdbcType=VARCHAR}            </if>
        </where>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by t1.ct_id  desc
            </otherwise>
        </choose>
    </select>
    
    <!-- 根据条件统计数量 -->
    <select id="countNumByMap" resultType="java.lang.Integer" parameterType="map">
    	select count(DISTINCT(t1.ct_id)) from t_evgl_tch_classroom t1
    	left join t_evgl_tch_classroom_trainee t8 on t1.ct_id = t8.ct_id
    	<where>
    			<if test="noEnd != null and noEnd.trim() != ''">
                and t1.classroom_state != '3'            
                </if>
				<if test="justShowThisYear != null and nowYear.trim() != ''">
                and t1.ct_Id not in 
                	(	select myroom.ct_id from t_evgl_tch_classroom myroom 
                		where 
                		myroom.create_user_id = #{createUserId} 
                		and myroom.classroom_state = "3" 
                		and substring(myroom.create_time, 1, 4) != #{nowYear}
               		)         
                </if>
				<if test="year != null and year.trim() != ''">
                and substring(t1.create_time, 1, 4) =#{year,jdbcType=VARCHAR}           
                </if>
				<if test="traineeId != null and traineeId.trim() != ''">
                and t8.trainee_id =#{traineeId,jdbcType=VARCHAR}            </if>
                <if test="createUserId != null and createUserId.trim() != ''">
                and t1.create_user_id =#{createUserId,jdbcType=VARCHAR}            </if>
                <if test="receiverUserId != null and receiverUserId.trim() != ''">
				and t1.receiver_user_id =#{receiverUserId,jdbcType=VARCHAR}            </if>
                <if test="state != null and state.trim() != ''">
                and t1.state =#{state,jdbcType=VARCHAR}            </if>
                <if test="name != null and name.trim() != ''">
                and t1.name like concat ('%', #{name,jdbcType=VARCHAR}, '%')            </if>
                <if test="majorId != null and majorId.trim() != ''">
                and t1.major_id =#{majorId,jdbcType=VARCHAR}            </if>
                <if test="teacherId != null and teacherId.trim() != ''">
                and t1.teacher_id =#{teacherId,jdbcType=VARCHAR}            </if>
                <if test="classId != null and classId.trim() != ''">
                and t1.class_id =#{classId,jdbcType=VARCHAR}            </if>
                <if test="pkgId != null and pkgId.trim() != ''">
                and t1.pkg_id =#{subjectId,jdbcType=VARCHAR}            </if>
                <if test="isPublic != null and isPublic.trim() != ''">
                and t1.is_public =#{isPublic,jdbcType=VARCHAR}            </if>
        </where>
    </select>
    
    <!-- 公共方法 t2.org_id as orgIdClass, --> 
	<select id="selectListMapForCommon" resultType="map" parameterType="map">
		select t1.ct_id as ctId, t1.name, ifnull(t1.pic, 'default_classroom.jpg') as pic, t1.class_id as classId, t1.study_num as studyNum, t1.is_check as isCheck,
		t1.major_id as majorId, t1.create_user_id as createUserId, t1.collect_num as collectNum, t1.like_num as likeNum, t1.if_live_lesson as ifLiveLesson, t1.link_url as linkUrl,
		t1.pkg_id as pkgId, t1.intro, t1.invitation_code as invitationCode, t1.classroom_state as classroomState, t1.classroom_state as classroomStateName,
		t1.teacher_id as teacherId, t1.receiver_user_id as receiverUserId,
		ifnull(t1.qr_code, '') as qrCode, if(t1.is_public = 'Y', '公开课', '')  as isPublic,
		t2.class_name as className, 
		ifnull(t10.trainee_name, t10.nick_name) as teacherName, IFNULL(t3.teacher_pic, ifnull(t10.trainee_head, '/uploads/defaulthead.png')) as teacherPic, t3.org_id as orgIdTeacher,
		t4.subject_name as subjectName, t4.subject_id as subjectId,
		t5.pkg_name as pkgName, ifnull(t5.pkg_res_count, 0) as pkgResCount, ifnull(t5.pkg_act_count, 0) as pkgActCount, t5.org_id as orgId, t5.release_status as releaseStatus,
		t6.subject_property as subjectProperty,
		ifnull(t7.trainee_id, '') as teachingAssistantId, IFNULL(t7.trainee_name, ifnull(t7.nick_name, '')) as traineeName, 
		IFNULL(t7.trainee_pic, ifnull(t7.trainee_head, '/uploads/defaulthead.png')) as traineePic,
		t8.state as classroomTraineeState, if(t8.state = 'N', '待审核', '') as classroomTraineeStateName,
		t9.ct_id as top,
		org.ORG_SHOWNAME as orgIdClass
		from t_evgl_tch_classroom t1
		left join t_evgl_tch_class t2 on t1.class_id = t2.class_id
		left join t_sys_org org on t2.org_id = org.org_id
		left join t_evgl_tch_teacher t3 on t1.teacher_id = t3.teacher_id
		left join t_evgl_pkg_info t5 on t1.pkg_id = t5.pkg_id
		left join t_evgl_book_subject t4 on t4.subject_id = t5.subject_id
		left join t_evgl_book_subperiod t6 on t4.subject_ref = t6.subject_id
		left join t_evgl_trainee_info t7 on t1.trainee_id = t7.trainee_id
		left join t_evgl_tch_classroom_trainee t8 on t1.ct_id = t8.ct_id
		left join t_evgl_tch_classroom_top t9 on t1.ct_id = t9.ct_id
		<choose>
            <when test="traineeId != null and traineeId.trim() != ''">
                and t9.trainee_id = #{traineeId}
            </when>
        </choose>
		left join t_evgl_trainee_info t10 on t3.trainee_id = t10.trainee_id
		
		<where>
				<if test="noEnd != null and noEnd.trim() != ''">
                and t1.classroom_state != '3'            
                </if>
				<if test="justShowThisYear != null and nowYear.trim() != ''">
                and t1.ct_Id not in 
                	(	select myroom.ct_id from t_evgl_tch_classroom myroom 
                		where 
                		myroom.create_user_id = #{createUserId} 
                		and myroom.classroom_state = "3" 
                		and substring(myroom.create_time, 1, 4) != #{nowYear}
               		)         
                </if>
				<if test="year != null and year.trim() != ''">
                and substring(t1.create_time, 1, 4) =#{year,jdbcType=VARCHAR}           
                </if>
				<if test="teacherName != null and teacherName.trim() != ''">
                and 
                (
                	t3.teacher_name like concat ('%', #{teacherName,jdbcType=VARCHAR}, '%') 
                	or t10.trainee_name like concat ('%', #{teacherName,jdbcType=VARCHAR}, '%') 
                	or t10.nick_name like concat ('%', #{teacherName,jdbcType=VARCHAR}, '%')
                )         
                </if>
                <if test="subjectName != null and teacherName.trim() != ''">
                and t4.subject_name like concat ('%', #{subjectName,jdbcType=VARCHAR}, '%') 
                </if>
                
				<if test="beginTime != null and beginTime.trim() != ''">
                and t1.create_time &gt;=#{beginTime,jdbcType=VARCHAR}           </if>
                <if test="endTime != null and endTime.trim() != ''">
                and t1.create_time &lt;=#{endTime,jdbcType=VARCHAR}           </if>
                
				<if test="classroomName != null and classroomName.trim() != ''">
                and t1.name like concat ('%', #{classroomName,jdbcType=VARCHAR}, '%')           </if>
				<if test="name != null and name.trim() != ''">
                and t1.name like concat ('%', #{name,jdbcType=VARCHAR}, '%')           </if>
				<if test="traineeId != null and traineeId.trim() != ''">
                and t8.trainee_id =#{traineeId,jdbcType=VARCHAR}            </if>
                <if test="subjectId != null and subjectId.trim() != ''">
                and t4.subject_ref =#{subjectId,jdbcType=VARCHAR}            </if>
                
                <if test="majorId != null and majorId.trim() != ''">
                and t1.major_id =#{majorId,jdbcType=VARCHAR}            </if>
                <if test="teacherId != null and teacherId.trim() != ''">
                and t1.teacher_id =#{teacherId,jdbcType=VARCHAR}            </if>
                <if test="classId != null and classId.trim() != ''">
                and t1.class_id =#{classId,jdbcType=VARCHAR}            </if>
                <if test="pkgId != null and pkgId.trim() != ''">
                and t1.pkg_id =#{subjectId,jdbcType=VARCHAR}            </if>
                <if test="isPublic != null and isPublic.trim() != ''">
                and t1.is_public =#{isPublic,jdbcType=VARCHAR}            </if>
                <if test="pic != null and pic.trim() != ''">
                and t1.pic =#{pic,jdbcType=VARCHAR}            </if>
                <if test="invitationCode != null and invitationCode.trim() != ''">
                and t1.invitation_code =#{invitationCode,jdbcType=VARCHAR}            </if>
                <if test="intro != null and intro.trim() != ''">
                and t1.intro =#{intro,jdbcType=VARCHAR}            </if>
                <if test="studyNum != null and studyNum != ''">
                and t1.study_num =#{studyNum,jdbcType=INTEGER}            </if>
                <if test="createUserId != null and createUserId.trim() != ''">
                and t1.create_user_id =#{createUserId,jdbcType=VARCHAR}            </if>
                <if test="createTime != null and createTime.trim() != ''">
                and t1.create_time =#{createTime,jdbcType=VARCHAR}            </if>
                <if test="updateTime != null and updateTime.trim() != ''">
                and t1.update_time =#{updateTime,jdbcType=VARCHAR}            </if>
                <if test="updateUserId != null and updateUserId.trim() != ''">
                and t1.update_user_id =#{updateUserId,jdbcType=VARCHAR}            </if>
                <if test="state != null and state.trim() != ''">
                and t1.state =#{state,jdbcType=VARCHAR}            </if>
                <if test="classroomState != null and classroomState.trim() != ''">
                and t1.classroom_state =#{classroomState,jdbcType=VARCHAR}            </if>
                <if test="isCheck != null and isCheck.trim() != ''">
                and t1.is_check =#{isCheck,jdbcType=VARCHAR}            </if>
                <if test="isTop != null and isTop.trim() != ''">
                and t1.is_top =#{isTop,jdbcType=VARCHAR}            </if>
                <if test="qrCode != null and qrCode.trim() != ''">
                and t1.qr_code =#{qrCode,jdbcType=VARCHAR}            </if>
                <if test="collectNum != null and collectNum != ''">
                and t1.collect_num =#{collectNum,jdbcType=INTEGER}            </if>
                <if test="likeNum != null and likeNum != ''">
                and t1.like_num =#{likeNum,jdbcType=INTEGER}            </if>
                <if test="beginTime != null and beginTime.trim() != ''">
                and t1.begin_time =#{beginTime,jdbcType=VARCHAR}            </if>
                <if test="endTime != null and endTime.trim() != ''">
                and t1.end_time =#{endTime,jdbcType=VARCHAR}            </if>
                <if test="platformAuditStatus != null and platformAuditStatus.trim() != ''">
                and t1.platform_audit_status =#{platformAuditStatus,jdbcType=VARCHAR}            </if>
        </where>
        group by t1.ct_id
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by t1.create_time desc
            </otherwise>
        </choose>
	</select>
	
	<select id="selectObjectMapById" parameterType="java.lang.String"
		resultType="map">
		select t1.ct_id as ctId, t1.major_id as majorId, t1.teacher_id as teacherId, t1.class_id as classId, t1.if_live_lesson as ifLiveLesson, t1.link_url as linkUrl,
		t1.pkg_id as pkgId, t1.pic, t1.invitation_code as invitationCode, t1.name, t1.intro, t1.study_num as studyNum,
		ifnull(t1.qr_code, '') as qrCode, t1.is_check as isCheck, t1.collect_num as collectNum, t1.like_num as likeNum,
		t1.is_public as isPublic, t1.state, t1.classroom_state as classroomState,
		t2.class_name as className,
		t3.ref_pkg_id as refPkgId,
		t4.subject_ref as subjectId
		from T_EVGL_TCH_CLASSROOM t1
		inner join t_evgl_tch_class t2 on t1.class_id = t2.class_id
		inner join t_evgl_pkg_info t3 on t1.pkg_id = t3.pkg_id
		inner join t_evgl_book_subject t4 on t3.subject_id = t4.subject_id
		WHERE t1.ct_id = #{ctId,jdbcType=VARCHAR} 
	</select>
    
    <insert id="insertBatch" parameterType="java.util.List">
    insert into t_evgl_tch_classroom
    (ct_id,major_id,teacher_id,class_id,pkg_id,is_public,pic,invitation_code,name,intro,
    study_num,create_user_id,create_time,update_time,update_user_id,state,trainee_id,
    classroom_state,is_check,is_top,qr_code,collect_num,like_num,begin_time,end_time,platform_audit_status,
    if_live_lesson,link_url
    )
    values
	    <foreach collection="list" item="obj" separator="," >
    		(
    			#{obj.ctId}, #{obj.majorId}, #{obj.teacherId}, #{obj.classId}, #{obj.pkgId},
    			#{obj.isPublic}, #{obj.pic}, #{obj.invitationCode}, #{obj.name}, #{obj.intro},
    			#{obj.studyNum}, #{obj.createUserId}, #{obj.createTime}, #{obj.updateTime}, #{obj.updateUserId}, 
    			#{obj.state},#{obj.traineeId},#{obj.classroomState},#{obj.isCheck},#{obj.isTop},
    			#{obj.qrCode},#{obj.collectNum},#{obj.likeNum},#{obj.beginTime},#{obj.endTime},
    			#{obj.platformAuditStatus},#{obj.ifLiveLesson},#{obj.linkUrl}
    		)
	   	</foreach>
    </insert>
    
    <!-- 更新数量 -->
    <update id="plusNum" parameterType="com.ossbar.modules.evgl.tch.domain.TevglTchClassroom">
    	update t_evgl_tch_classroom
    	<set>
    		<if test="studyNum != null">
    			study_num = ifnull(study_num, 0) + #{studyNum,jdbcType=INTEGER}
    		</if>
    		<if test="collectNum != null">
				collect_num = ifnull(collect_num, 0) + #{collectNum,jdbcType=INTEGER},
			</if>
			<if test="likeNum != null">
				like_num = ifnull(like_num, 0) + #{likeNum,jdbcType=INTEGER},
			</if>
			<if test="viewNum != null">
				view_num = ifnull(view_num, 0) + #{viewNum,jdbcType=INTEGER},
			</if>
    	</set>
    	where ct_id = #{ctId,jdbcType=VARCHAR} 
    </update>
    
	<select id="getCtIdsByTraineeId" parameterType="java.lang.String" resultType="map">
		select ct_id as ctId, state, IFNULL(access_state, 'N') as accessState from t_evgl_tch_classroom_trainee
		where trainee_id = #{traineeId}
	</select>
    
    <!-- [我的书架]查询参与过的,创建的以及免费的课程信息 -->
    <select id="queryBookshelf"  resultType="map" parameterType="map">
        select t.* 
			from
				(
					select t1.ct_id as ctId, t1.pkg_id as pkgId, t3.subject_id as subjectId, 
					t4.subject_name as subjectName, t5.major_id as majorId,t1.teacher_id as teacherId, 
					null as subjectLogo,t3.view_num as viewNum,t3.subject_author as subjectAuthor, 
					t3.subject_ref subjectRef, MAX( t2.deploy_time ) AS deployTime 
					from t_evgl_tch_classroom t1
					inner join t_evgl_pkg_info t2 on t1.pkg_id = t2.pkg_id
					inner join t_evgl_book_subject t3 on t2.subject_id = t3.subject_id
					inner join t_evgl_book_subject t4 on t3.subject_ref = t4.subject_id
					inner join t_evgl_book_subperiod t5 on t4.subject_id= t5.subject_id
					<where>
						<if test="teacherId != null and teacherId.trim() != ''">
		               	and t1.teacher_id = #{teacherId,jdbcType=VARCHAR}  and t1.state = "Y"          
		                </if>
		                <if test="subjectId != null and subjectId.trim() != ''">
		               	and t4.subject_id = #{subjectId,jdbcType=VARCHAR}    
		                </if>
					</where>
					GROUP BY t4.subject_name
					
					union all
					
					select t1.ct_id as ctId, t1.pkg_id as pkgId, t3.subject_id as subjectId, 
					t4.subject_name as subjectName, t5.major_id as majorId, t0.trainee_id as teacherId, 
					t4.subject_logo as subjectLogo,t3.view_num as viewNum,t3.subject_author as subjectAuthor, 
					t3.subject_ref subjectRef, MAX( t2.deploy_time ) AS deployTime
					from t_evgl_tch_classroom_trainee t0
					inner join t_evgl_tch_classroom t1 on t0.ct_id = t1.ct_id
					inner join t_evgl_pkg_info t2 on t1.pkg_id = t2.pkg_id
					inner join t_evgl_book_subject t3 on t2.subject_id = t3.subject_id
					inner join t_evgl_book_subject t4 on t3.subject_ref = t4.subject_id
					inner join t_evgl_book_subperiod t5 on t4.subject_id= t5.subject_id
					<where>
						<if test="traineeId != null and traineeId.trim() != ''">
		               	and t0.trainee_id = #{traineeId,jdbcType=VARCHAR} and t1.state = "Y"         
		                </if>
		                <if test="subjectId != null and subjectId.trim() != ''">
		               	and t4.subject_id = #{subjectId,jdbcType=VARCHAR}    
		                </if>
					</where>
					GROUP BY t4.subject_name
					
					union all 
					
					select null as ctId, null as pkgId, t1.subject_id as subjectId, t1.subject_name as subjectName, 
					t2.major_id as majorId,null as teacherId,t1.subject_logo as subjectLogo,t1.view_num as viewNum,
					t1.subject_author as subjectAuthor, t1.subject_ref subjectRef, NULL AS deployTime
					from t_evgl_book_subject t1
					inner join t_evgl_book_subperiod t2 on t1.subject_id = t2.subject_id
					<where>
						(t1.subject_ref is null or t1.subject_ref = '')
		                <if test="subjectId != null and subjectId.trim() != ''">
	               		and t1.subject_id = #{subjectId,jdbcType=VARCHAR}    
		                </if>
					</where>
				)
			t 
			<where>
				<if test="majorIds != null and majorIds.size() > 0">
					and t.majorId in
					<foreach collection="majorIds" item="majorId" open="(" separator="," close=")">
					 	#{majorId,jdbcType=VARCHAR}
					</foreach>
					
				</if>
				<if test="subjectIds != null and subjectIds.size() > 0">
					and t.subjectId in
					<foreach collection="subjectIds" item="subjectId" open="(" separator="," close=")">
					 	#{subjectId,jdbcType=VARCHAR}
					</foreach>
				</if>
				
				<if test="majorId != null and majorId.trim() != ''">
					and t.majorId = #{majorId,jdbcType=VARCHAR}
				</if>
				<if test="subjectRef != null and subjectRef.trim() != ''">
					and t.subjectRef = #{subjectRef,jdbcType=VARCHAR}
				</if>
				<if test="subjectName != null and subjectName.trim() != ''">
					and t.subjectName like concat ('%', #{subjectName,jdbcType=VARCHAR}, '%') 
				</if>
			</where>       
    </select>
    
    <!-- 用于更新收藏数、点赞数以及阅读量 -->
    <update id="updateNum" parameterType="com.ossbar.modules.evgl.tch.domain.TevglTchClassroom">
    	update t_evgl_tch_classroom
    	<set>
	    	<if test="collectNum != null">
	    		collect_num = IFNULL(collect_num, 0) + #{collectNum, jdbcType=INTEGER},
	    	</if>
	    	<if test="likeNum != null">
	    		like_num = IFNULL(like_num, 0) + #{likeNum, jdbcType=INTEGER},
	    	</if>
    	</set>
    	WHERE 
    	ct_id = #{ctId,jdbcType=VARCHAR}      
    </update>
    
    <select id="selectCtIdPkgIdList" resultType="map"
        parameterType="map">
        select t1.ct_id as ctId, t1.pkg_id as pkgId from T_EVGL_TCH_CLASSROOM t1
        <where>
        	
        		<if test="teacherIds != null and teacherIds.size() > 0">
                	and t1.teacher_id in
                	<foreach collection="teacherIds" item="teacherId" open="(" separator="," close=")">
                		#{teacherId} 
                	</foreach>
                </if>
        		<if test="ctIds != null and ctIds.size() > 0">
                	and t1.ct_id in
                	<foreach collection="ctIds" item="ctId" open="(" separator="," close=")">
                		#{ctId} 
                	</foreach>
                </if>
                <if test="isStart != null and isStart.trim() != ''">
                and t1.classroom_state != "1"            
                </if>
                <if test="majorId != null and majorId.trim() != ''">
                and t1.major_id =#{majorId,jdbcType=VARCHAR}            </if>
                <if test="teacherId != null and teacherId.trim() != ''">
                and t1.teacher_id =#{teacherId,jdbcType=VARCHAR}            </if>
                <if test="classId != null and classId.trim() != ''">
                and t1.class_id =#{classId,jdbcType=VARCHAR}            </if>
                <if test="pkgId != null and pkgId.trim() != ''">
                and t1.pkg_id =#{pkgId,jdbcType=VARCHAR}            </if>
                <if test="isPublic != null and isPublic.trim() != ''">
                and t1.is_public =#{isPublic,jdbcType=VARCHAR}            </if>
                <if test="pic != null and pic.trim() != ''">
                and t1.pic =#{pic,jdbcType=VARCHAR}            </if>
                <if test="invitationCode != null and invitationCode.trim() != ''">
                and t1.invitation_code =#{invitationCode,jdbcType=VARCHAR}            </if>
                <if test="name != null and name.trim() != ''">
                and t1.name =#{name,jdbcType=VARCHAR}            </if>
                <if test="intro != null and intro.trim() != ''">
                and t1.intro =#{intro,jdbcType=VARCHAR}            </if>
                <if test="studyNum != null and studyNum != ''">
                and t1.study_num =#{studyNum,jdbcType=INTEGER}            </if>
                <if test="createUserId != null and createUserId.trim() != ''">
                and t1.create_user_id =#{createUserId,jdbcType=VARCHAR}            </if>
                <if test="createTime != null and createTime.trim() != ''">
                and t1.create_time =#{createTime,jdbcType=VARCHAR}            </if>
                <if test="updateTime != null and updateTime.trim() != ''">
                and t1.update_time =#{updateTime,jdbcType=VARCHAR}            </if>
                <if test="updateUserId != null and updateUserId.trim() != ''">
                and t1.update_user_id =#{updateUserId,jdbcType=VARCHAR}            </if>
                <if test="state != null and state.trim() != ''">
                and t1.state =#{state,jdbcType=VARCHAR}            </if>
                <if test="traineeId != null and traineeId.trim() != ''">
                and t1.trainee_id =#{traineeId,jdbcType=VARCHAR}            </if>
                <if test="classroomState != null and classroomState.trim() != ''">
                and t1.classroom_state =#{classroomState,jdbcType=VARCHAR}            </if>
                <if test="isCheck != null and isCheck.trim() != ''">
                and t1.is_check =#{isCheck,jdbcType=VARCHAR}            </if>
                <if test="isTop != null and isTop.trim() != ''">
                and t1.is_top =#{isTop,jdbcType=VARCHAR}            </if>
                <if test="qrCode != null and qrCode.trim() != ''">
                and t1.qr_code =#{qrCode,jdbcType=VARCHAR}            </if>
                <if test="collectNum != null and collectNum != ''">
                and t1.collect_num =#{collectNum,jdbcType=INTEGER}            </if>
                <if test="likeNum != null and likeNum != ''">
                and t1.like_num =#{likeNum,jdbcType=INTEGER}            </if>
                <if test="beginTime != null and beginTime.trim() != ''">
                and t1.begin_time =#{beginTime,jdbcType=VARCHAR}            </if>
                <if test="endTime != null and endTime.trim() != ''">
                and t1.end_time =#{endTime,jdbcType=VARCHAR}            </if>
                <if test="platformAuditStatus != null and platformAuditStatus.trim() != ''">
                and t1.platform_audit_status =#{platformAuditStatus,jdbcType=VARCHAR}            </if>
        </where>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by t1.ct_id  desc
            </otherwise>
        </choose>
    </select>
    
    <select id="queryImGroupUserList" resultType="map"
        parameterType="map">
        select t1.groupuser_id as groupuserId, t1.user_id as userId, t1.group_id as groupId,
        t1.groupuser_remark as groupuserRemark, t1.groupuser_description as groupuserDescription,
        t1.groupuser_admin as groupuserAdmin,
        ifnull(t3.trainee_name, t3.nick_name) as username, t3.trainee_head as userimg,
        t3.trainee_sex
        from T_IM_GROUP_USER t1
        inner join t_evgl_trainee_info t3 on t1.user_id = t3.trainee_id
        <where>
        		 <if test="username != null and username.trim() != ''">
                and (t3.trainee_name like concat ('%', #{username,jdbcType=VARCHAR}, '%') or t3.nick_name like concat ('%', #{username,jdbcType=VARCHAR}, '%'))
                </if>
                <if test="userId != null and userId.trim() != ''">
                and t1.user_id =#{userId,jdbcType=VARCHAR}            </if>
                <if test="groupId != null and groupId.trim() != ''">
                and t1.group_id =#{groupId,jdbcType=VARCHAR}            </if>
                <if test="groupuserRemark != null and groupuserRemark.trim() != ''">
                and t1.groupuser_remark =#{groupuserRemark,jdbcType=VARCHAR}            </if>
                <if test="groupuserDescription != null and groupuserDescription.trim() != ''">
                and t1.groupuser_description =#{groupuserDescription,jdbcType=VARCHAR}            </if>
                <if test="groupuserAdmin != null and groupuserAdmin.trim() != ''">
                and t1.groupuser_admin =#{groupuserAdmin,jdbcType=VARCHAR}            </if>
        </where>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by t1.groupuser_admin desc
            </otherwise>
        </choose>
    </select>
    <select id="selectListMapForCommonV2" parameterType="map" resultType="map">

		select t.* from (
			select t1.ct_id as ctId, t1.name, ifnull(t1.pic, 'default_classroom.jpg') as pic, t1.class_id as classId, t1.study_num as studyNum,
			t1.is_check as isCheck, t1.major_id as majorId, t1.create_user_id as createUserId, t1.create_time as createTime , t1.collect_num as collectNum,
			t1.like_num as likeNum, t1.if_live_lesson as ifLiveLesson, t1.link_url as linkUrl, t1.pkg_id as pkgId, t1.intro,
			t1.invitation_code as invitationCode, t1.classroom_state as classroomState, t1.classroom_state as classroomStateName,
			t1.teacher_id as teacherId, ifnull(t1.qr_code, '') as qrCode, if(t1.is_public = 'Y', '公开课', '')  as isPublic,
			t1.state, t1.receiver_user_id as receiverUserId,
			t2.class_name as className, t3.org_id as orgIdTeacher, t4.subject_name as subjectName, t4.subject_id as subjectId, t4.subject_ref as subjectRef,
			ifnull(t3.teacher_name, ifnull(t10.trainee_name, t10.nick_name)) as teacherName, IFNULL(t3.teacher_pic, ifnull(t10.trainee_head, '/uploads/defaulthead.png')) as teacherPic,
			t5.pkg_name as pkgName, ifnull(t5.pkg_res_count, 0) as pkgResCount, ifnull(t5.pkg_act_count, 0) as pkgActCount, t5.org_id as orgId, t5.release_status as releaseStatus,
			t6.subject_property as subjectProperty, ifnull(t7.trainee_id, '') as teachingAssistantId, IFNULL(t7.trainee_name, ifnull(t7.nick_name, '')) as traineeName,
			IFNULL(t7.trainee_pic, ifnull(t7.trainee_head, '/uploads/defaulthead.png')) as traineePic,
			t8.state as classroomTraineeState, if(t8.state = 'N', '待审核', '') as classroomTraineeStateName,
			t9.ct_id as top, org.ORG_SHOWNAME as orgIdClass,
			t1.classroom_state, t9.update_time, t1.create_time
			from t_evgl_tch_classroom t1
			left join t_evgl_tch_class t2 on t1.class_id = t2.class_id
			left join t_sys_org org on t2.org_id = org.org_id
			left join t_evgl_tch_teacher t3 on t1.teacher_id = t3.teacher_id
			left join t_evgl_pkg_info t5 on t1.pkg_id = t5.pkg_id
			left join t_evgl_book_subject t4 on t4.subject_id = t5.subject_id
			left join t_evgl_book_subperiod t6 on t4.subject_ref = t6.subject_id
			left join t_evgl_trainee_info t7 on t1.trainee_id = t7.trainee_id
			left join t_evgl_tch_classroom_trainee t8 on t1.ct_id = t8.ct_id
			left join t_evgl_tch_classroom_top t9 on t1.ct_id = t9.ct_id
			<choose>
				<when test="traineeId != null and traineeId.trim() != ''">
					and t9.trainee_id = #{traineeId}
				</when>
			</choose>
			left join t_evgl_trainee_info t10 on t3.trainee_id = t10.trainee_id
			where t1.receiver_user_id is null
			<if test="createUserId != null and createUserId.trim() != ''">
				and t1.create_user_id =#{createUserId,jdbcType=VARCHAR}
			</if>

			union all

			select t1.ct_id as ctId, t1.name, ifnull(t1.pic, 'default_classroom.jpg') as pic, t1.class_id as classId, t1.study_num as studyNum,
			t1.is_check as isCheck, t1.major_id as majorId,  t1.create_user_id as createUserId, t1.create_time as createTime , t1.collect_num as collectNum,
			t1.like_num as likeNum, t1.if_live_lesson as ifLiveLesson, t1.link_url as linkUrl, t1.pkg_id as pkgId, t1.intro,
			t1.invitation_code as invitationCode, t1.classroom_state as classroomState, t1.classroom_state as classroomStateName,
			t1.teacher_id as teacherId, ifnull(t1.qr_code, '') as qrCode, if(t1.is_public = 'Y', '公开课', '')  as isPublic,
			t1.state, t1.receiver_user_id as receiverUserId,
			t2.class_name as className, t3.org_id as orgIdTeacher, t4.subject_name as subjectName, t4.subject_id as subjectId, t4.subject_ref as subjectRef,
			ifnull(t3.teacher_name, ifnull(t10.trainee_name, t10.nick_name)) as teacherName, IFNULL(t3.teacher_pic, ifnull(t10.trainee_head, '/uploads/defaulthead.png')) as teacherPic,
			t5.pkg_name as pkgName, ifnull(t5.pkg_res_count, 0) as pkgResCount, ifnull(t5.pkg_act_count, 0) as pkgActCount, t5.org_id as orgId, t5.release_status as releaseStatus,
			t6.subject_property as subjectProperty, ifnull(t7.trainee_id, '') as teachingAssistantId, IFNULL(t7.trainee_name, ifnull(t7.nick_name, '')) as traineeName,
			IFNULL(t7.trainee_pic, ifnull(t7.trainee_head, '/uploads/defaulthead.png')) as traineePic,
			t8.state as classroomTraineeState, if(t8.state = 'N', '待审核', '') as classroomTraineeStateName,
			t9.ct_id as top, org.ORG_SHOWNAME as orgIdClass,
			t1.classroom_state, t9.update_time, t1.create_time
			from t_evgl_tch_classroom t1
			left join t_evgl_tch_class t2 on t1.class_id = t2.class_id
			left join t_sys_org org on t2.org_id = org.org_id
			left join t_evgl_tch_teacher t3 on t1.receiver_user_id = t3.teacher_id
			left join t_evgl_pkg_info t5 on t1.pkg_id = t5.pkg_id
			left join t_evgl_book_subject t4 on t4.subject_id = t5.subject_id
			left join t_evgl_book_subperiod t6 on t4.subject_ref = t6.subject_id
			left join t_evgl_trainee_info t7 on t1.trainee_id = t7.trainee_id
			left join t_evgl_tch_classroom_trainee t8 on t1.ct_id = t8.ct_id
			left join t_evgl_tch_classroom_top t9 on t1.ct_id = t9.ct_id
			<choose>
				<when test="traineeId != null and traineeId.trim() != ''">
					and t9.trainee_id = #{traineeId}
				</when>
			</choose>
			left join t_evgl_trainee_info t10 on t3.trainee_id = t10.trainee_id
			<where>
				<if test="createUserId != null and createUserId.trim() != ''">
					and t1.receiver_user_id =#{createUserId,jdbcType=VARCHAR}
				</if>
			</where>

		) t
		<where>
			<if test="noEnd != null and noEnd.trim() != ''">
				and t.classroom_state != '3'
			</if>
			<if test="justShowThisYear != null and nowYear.trim() != ''">
				and t.ctId not in
				(
					select myroom.ct_id from t_evgl_tch_classroom myroom
					where myroom.create_user_id = #{createUserId}
				    and myroom.classroom_state = "3"
				    and substring(myroom.create_time, 1, 4) != #{nowYear}
				)
			</if>
			<if test="year != null and year.trim() != ''">
				and substring(t.createTime, 1, 4) =#{year,jdbcType=VARCHAR}
			</if>
			<if test="subjectName != null and teacherName.trim() != ''">
				and t.subjectName like concat ('%', #{subjectName,jdbcType=VARCHAR}, '%')
			</if>
			<if test="beginTime != null and beginTime.trim() != ''">
				and t.createTime &gt;=#{beginTime,jdbcType=VARCHAR}
			</if>
			<if test="endTime != null and endTime.trim() != ''">
				and t.createTime &lt;=#{endTime,jdbcType=VARCHAR}
			</if>
			<if test="classroomName != null and classroomName.trim() != ''">
				and t.name like concat ('%', #{classroomName,jdbcType=VARCHAR}, '%')
			</if>
			<if test="state != null and state.trim() != ''">
				and t.state =#{state,jdbcType=VARCHAR}
			</if>
			<if test="classroomState != null and classroomState.trim() != ''">
				and t.classroomState =#{classroomState,jdbcType=VARCHAR}
			</if>
			<if test="name != null and name.trim() != ''">
				and t.name like concat ('%', #{name,jdbcType=VARCHAR}, '%')
			</if>
			<if test="traineeId != null and traineeId.trim() != ''">
				and t.traineeId =#{traineeId,jdbcType=VARCHAR}
			</if>
			<if test="subjectId != null and subjectId.trim() != ''">
				and t.subjectRef =#{subjectId,jdbcType=VARCHAR}
			</if>
			<if test="invitationCode != null and invitationCode.trim() != ''">
                and t.invitationCode =#{invitationCode,jdbcType=VARCHAR}            
            </if>
            <if test="majorId != null and majorId.trim() != ''">
                and t.majorId =#{majorId,jdbcType=VARCHAR}            
            </if>
		</where>
		group by t.ctId
		<choose>
			<when test="sidx != null and sidx.trim() != ''">
				order by ${sidx} ${order}
			</when>
			<otherwise>
				order by t.create_time desc
			</otherwise>
		</choose>
	</select>
	
	<update id="updateReceiverUserId" parameterType="com.ossbar.modules.evgl.tch.domain.TevglTchClassroom">
    	update t_evgl_tch_classroom set receiver_user_id = #{receiverUserId} where ct_id = #{ctId,jdbcType=VARCHAR}      
    </update>
    
    <update id="updateTraineeId" parameterType="com.ossbar.modules.evgl.tch.domain.TevglTchClassroom">
    	update t_evgl_tch_classroom set trainee_id = #{traineeId} where ct_id = #{ctId,jdbcType=VARCHAR}      
    </update>
    
    <select id="countSignupActivityNum" parameterType="java.lang.String" resultType="Integer">
    	select count(*) from t_evgl_pkg_activity_relation where activity_type = '8' and activity_state in ('1', '2') and pkg_id = (select pkg_id from t_evgl_tch_classroom where ct_id = #{ctId})
    </select>
</mapper>

